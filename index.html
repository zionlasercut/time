<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>膠板生產時間計算器</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --border:#e5e7eb; --muted:#6b7280;
    --title:#111827; --accent:#3b82f6; --danger:#ef4444; --thead:#f8fafc; --group:#e6effe;
    --shadow:0 1px 2px rgba(0,0,0,.04);
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b1020; --card:#0e1426; --border:#1f2a44; --muted:#93a4c0;
      --title:#e5ecff; --accent:#5ea0ff; --danger:#ff7070; --thead:#0f1a33; --group:#0d2a5a;
      --shadow:none;
    }
  }
  html,body{margin:0;padding:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans";color:var(--title)}
  .wrap{max-width:920px;margin:0 auto;padding:16px}
  h1{margin:8px 0 12px;font-size:28px;font-weight:800}
  .status{color:var(--muted);margin:0 0 10px 2px;font-size:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);overflow:hidden}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{background:var(--thead);text-align:left;padding:10px 12px;border-bottom:1px solid var(--border);color:var(--muted)}
  tbody td, tfoot td{border-bottom:1px solid var(--border)}
  .group-row th{background:var(--group);color:var(--title);font-weight:700;padding:10px 12px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
  .label{padding:10px 12px}
  .ctrl{padding:10px 12px}
  .time{padding:10px 12px;text-align:right;color:var(--danger);font-variant-numeric:tabular-nums}
  select,input[type="number"]{width:100%;padding:9px 10px;border:1px solid var(--border);border-radius:8px;background:transparent;color:inherit}
  option{color:initial}
  .hint{color:var(--muted);font-size:13px;padding:8px 12px}
  tfoot td{background:var(--thead)}
  .tfoot-label{padding:10px 12px;font-weight:700}
  .tfoot-time{padding:10px 12px;text-align:right;color:var(--danger);font-weight:800}
  .actions{display:flex;justify-content:flex-end;padding:12px}
  .btn{padding:10px 16px;border-radius:10px;border:0;cursor:pointer;background:var(--accent);color:#fff;font-weight:700}
  .btn:active{transform:translateY(1px)}
  @media (max-width:640px){
    .wrap{padding:10px}
    h1{font-size:22px}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>膠板生產時間計算器</h1>
  <div class="status" id="status">狀態：正在從同資料夾讀取 working_time.xlsx…</div>

  <div class="card">
    <table aria-label="膠板生產時間計算器">
      <thead>
        <tr>
          <th style="width:40%">項目</th>
          <th style="width:45%">選項</th>
          <th style="width:15%;text-align:right">時間 (分)</th>
        </tr>
      </thead>
      <tbody>
        <tr class="group-row"><th colspan="3">1. 量度及核對呎吋</th></tr>
        <tr>
          <td class="label">比例?</td>
          <td class="ctrl"><select id="scale"><option value="">載入中…</option></select></td>
          <td class="time" id="t-scale">0</td>
        </tr>
        <tr>
          <td class="label">原廠模型?</td>
          <td class="ctrl"><select id="oem"><option value="">載入中…</option></select></td>
          <td class="time" id="t-oem">0</td>
        </tr>
        <tr>
          <td class="label">涉及曲面?</td>
          <td class="ctrl"><select id="curved"><option value="">載入中…</option></select></td>
          <td class="time" id="t-curved">0</td>
        </tr>
        <tr><td colspan="3" class="hint">量度與核對通常只做一次，不乘以數量。</td></tr>

        <tr class="group-row"><th colspan="3">2. 繪圖</th></tr>
        <tr>
          <td class="label">有參考圖?</td>
          <td class="ctrl"><select id="hasRef"><option value="">載入中…</option></select></td>
          <td class="time" id="t-ref">0</td>
        </tr>
        <tr>
          <td class="label">涉及疊加?</td>
          <td class="ctrl"><select id="drawOverlay"><option value="">載入中…</option></select></td>
          <td class="time" id="t-drawOverlay">0</td>
        </tr>
        <tr>
          <td class="label">膠板大小?</td>
          <td class="ctrl"><select id="size"><option value="">載入中…</option></select></td>
          <td class="time" id="t-size">0</td>
        </tr>
        <tr>
          <td class="label">膠板厚度?</td>
          <td class="ctrl"><select id="thickness"><option value="">載入中…</option></select></td>
          <td class="time" id="t-thickness">0</td>
        </tr>
        <tr><td colspan="3" class="hint">繪圖通常只做一次。</td></tr>

        <tr class="group-row"><th colspan="3">3. 列印膠板</th></tr>
        <tr>
          <td class="label">涉及疊加?</td>
          <td class="ctrl"><select id="printOverlay"><option value="">載入中…</option></select></td>
          <td class="time" id="t-printOverlay">0</td>
        </tr>
        <tr>
          <td class="label">涉及不同厚度膠板?</td>
          <td class="ctrl"><select id="multiThickness"><option value="">載入中…</option></select></td>
          <td class="time" id="t-multiThickness">0</td>
        </tr>
        <tr>
          <td class="label">列印數量？<div class="hint">(輸入塊數)</div></td>
          <td class="ctrl"><input id="printQty" type="number" min="0" step="1" value="0"></td>
          <td class="time" id="t-printTotal">0</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td class="tfoot-label">總時間 (分鐘)</td>
          <td></td>
          <td class="tfoot-time" id="t-grand">0</td>
        </tr>
      </tfoot>
    </table>
    <div class="actions">
      <button class="btn" id="btnClear">清除</button>
    </div>
  </div>
</div>

<!-- 讀取 Excel 的 SheetJS（瀏覽器端） -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ========= 只改「閱讀標題」的邏輯，其餘保持不變 ========= */

const $ = id => document.getElementById(id);
const E = {
  scale: $('scale'),
  oem: $('oem'),
  curved: $('curved'),
  hasRef: $('hasRef'),
  drawOverlay: $('drawOverlay'),
  size: $('size'),
  thickness: $('thickness'),
  printOverlay: $('printOverlay'),
  multiThickness: $('multiThickness'),
  printQty: $('printQty'),
  t: {
    scale: $('t-scale'), oem: $('t-oem'), curved: $('t-curved'),
    ref: $('t-ref'), drawOverlay: $('t-drawOverlay'), size: $('t-size'),
    thickness: $('t-thickness'), printOverlay: $('t-printOverlay'),
    multiThickness: $('t-multiThickness'), printTotal: $('t-printTotal'),
    grand: $('t-grand')
  },
  status: $('status')
};

let tables = null;
let currentGroup = null;

document.addEventListener('DOMContentLoaded', () => {
  attachEvents();
  loadExcel();
});

async function loadExcel(){
  try{
    E.status.textContent = '狀態：正在從同資料夾讀取 working_time.xlsx…';
    const res = await fetch('working_time.xlsx', { cache:'no-store' });
    if(!res.ok) throw new Error('無法讀取 working_time.xlsx');
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf, { type:'array' });
    tables = parseWorkbookHeaderAware(wb); // 只改在這裡：用「讀取標題」解析
    fillSelects();
    compute();
    E.status.textContent = '狀態：資料已載入';
  }catch(err){
    console.error(err);
    E.status.textContent = '狀態：讀取失敗，請確認 working_time.xlsx 與本檔同資料夾。';
  }
}

/* 只參考表頭進行解析（自動偵測表頭列） */
function sheetMatrix(wb, name){
  const ws = wb.Sheets[name];
  if(!ws) return [];
  // 以 header:1 取得「二維陣列」, 我們自決表頭是哪一列
  return XLSX.utils.sheet_to_json(ws, { header:1, defval:'', raw:true });
}
// 找出表頭行索引：尋找包含「時間/選項/比例/分組」字樣的一列
function detectHeaderIndex(matrix, type){
  const keys = type==='scale'
    ? ['比例','比例?','比例 ?','分組','群組','Group','時間']
    : (type==='yesno' ? ['分組','群組','Group','選項','Option','時間'] : ['選項','Option','時間']);
  const isKey = v => keys.some(k => String(v||'').toString().includes(k));
  const limit = Math.min(10, matrix.length); // 前 10 列中尋找
  for(let i=0;i<limit;i++){
    const row = matrix[i] || [];
    const hit = row.filter(isKey).length;
    if(hit >= 1) return i; // 至少含 1 個關鍵詞就視為表頭
  }
  return 0; // 找不到就當第 0 列是表頭
}
function rowsAfterHeader(matrix, headerIdx){
  const header = (matrix[headerIdx] || []).map(h => String(h||'').trim());
  const rows = [];
  for(let i=headerIdx+1;i<matrix.length;i++){
    const r = matrix[i] || [];
    if(r.every(c => String(c).trim()==='')) continue; // 全空行略過
    const obj = {};
    for(let j=0;j<header.length;j++){
      const key = header[j] || `COL${j}`;
      obj[key] = r[j];
    }
    rows.push(obj);
  }
  return { header, rows };
}
// 容錯取值
function take(obj, keys, fallback=''){
  for(const k of keys){
    if(k in obj && obj[k] !== undefined && obj[k] !== '') return obj[k];
  }
  // 模糊匹配（欄名含關鍵字）
  const want = keys.map(k => String(k));
  for(const kk in obj){
    const key = String(kk);
    if(want.some(w => key.includes(w))) return obj[kk];
  }
  return fallback;
}

function parseWorkbookHeaderAware(wb){
  // 比例
  const mScale = sheetMatrix(wb,'比例');
  const idxScale = detectHeaderIndex(mScale,'scale');
  const dScale = rowsAfterHeader(mScale, idxScale).rows;
  const scale = dScale.map(r => ({
    label: String(take(r, ['比例?','比例 ?','比例'], '')).trim(),
    group: String(take(r, ['分組','群組','Group'], 'A')).trim() || 'A',
    time: Number(take(r, ['時間'], 0)) || 0
  })).filter(r => r.label);

  // Yes/No（依分組）
  function yesNoByGroup(sheet){
    const m = sheetMatrix(wb, sheet);
    const idx = detectHeaderIndex(m,'yesno');
    const rows = rowsAfterHeader(m, idx).rows;
    const map = {};
    rows.forEach(r=>{
      const g = String(take(r, ['分組','群組','Group'], '')).trim();
      const opt = String(take(r, ['選項','Option'], '')).trim();
      const t = Number(take(r, ['時間'], 0)) || 0;
      if(!g || !opt) return;
      if(!map[g]) map[g] = {};
      map[g][opt] = t;
    });
    return map;
  }
  const oem = yesNoByGroup('原廠模型');
  const curved = yesNoByGroup('涉及曲面');
  const hasRef = yesNoByGroup('有參考圖');
  const drawOverlay = yesNoByGroup('繪圖疊加');

  // 一般選項-時間
  function optionTime(sheet){
    const m = sheetMatrix(wb, sheet);
    const idx = detectHeaderIndex(m,'option');
    const rows = rowsAfterHeader(m, idx).rows;
    return rows.map(r=>{
      const label = String(take(r, ['選項','Option'], String(take(r, Object.keys(r), '')))).trim();
      const time = Number(take(r, ['時間'], 0)) || 0;
      return { label, time };
    }).filter(x => x.label);
  }
  const size = optionTime('膠板大小');
  const thickness = optionTime('膠板厚度');
  const printOverlay = optionTime('列印疊加');
  const multiThickness = optionTime('列印不同厚度');

  return { scale, oem, curved, hasRef, drawOverlay, size, thickness, printOverlay, multiThickness };
}

/* UI 填充與計算（保持不變） */
function fillSelectOptions(el, arr){
  el.innerHTML = '<option value="">— 請選擇 —</option>' +
    arr.map((r,i)=>`<option value="${i}">${r.label}</option>`).join('');
}
function fillYesNo(el){
  el.innerHTML = '<option value="">— 請選擇 —</option><option value="Yes">Yes</option><option value="No">No</option>';
}
function fillSelects(){
  fillSelectOptions(E.scale, tables.scale);
  [E.oem,E.curved,E.hasRef,E.drawOverlay].forEach(fillYesNo);
  fillSelectOptions(E.size, tables.size);
  fillSelectOptions(E.thickness, tables.thickness);
  fillSelectOptions(E.printOverlay, tables.printOverlay);
  fillSelectOptions(E.multiThickness, tables.multiThickness);
}
function byGroup(tbl, val){
  if(!currentGroup || !val) return 0;
  const g = tbl[currentGroup] || {};
  return Number(g[val]) || 0;
}
function compute(){
  if(!tables) return;

  let tScale = 0;
  if(E.scale.value !== ''){
    const row = tables.scale[Number(E.scale.value)];
    tScale = row?.time || 0;
    currentGroup = row?.group || null;
  } else currentGroup = null;
  E.t.scale.textContent = tScale;

  const tOem = byGroup(tables.oem, E.oem.value);
  const tCurved = byGroup(tables.curved, E.curved.value);
  E.t.oem.textContent = tOem;
  E.t.curved.textContent = tCurved;

  const tRef = byGroup(tables.hasRef, E.hasRef.value);
  const tDrawOverlay = byGroup(tables.drawOverlay, E.drawOverlay.value);
  const tSize = E.size.value!=='' ? tables.size[Number(E.size.value)].time : 0;
  const tThickness = E.thickness.value!=='' ? tables.thickness[Number(E.thickness.value)].time : 0;
  E.t.ref.textContent = tRef;
  E.t.drawOverlay.textContent = tDrawOverlay;
  E.t.size.textContent = tSize;
  E.t.thickness.textContent = tThickness;

  const tPrintOverlay = E.printOverlay.value!=='' ? tables.printOverlay[Number(E.printOverlay.value)].time : 0;
  const tMultiThickness = E.multiThickness.value!=='' ? tables.multiThickness[Number(E.multiThickness.value)].time : 0;
  E.t.printOverlay.textContent = tPrintOverlay;
  E.t.multiThickness.textContent = tMultiThickness;

  const qty = Math.max(0, parseInt(E.printQty.value || '0', 10));
  const printUnit = tPrintOverlay + tMultiThickness;
  const printTotal = printUnit * qty;
  E.t.printTotal.textContent = printTotal;

  const measureSum = tScale + tOem + tCurved;
  const drawSum = tRef + tDrawOverlay + tSize + tThickness;
  const grand = measureSum + drawSum + printTotal;
  E.t.grand.textContent = grand;
}
function attachEvents(){
  [E.scale,E.oem,E.curved,E.hasRef,E.drawOverlay,E.size,E.thickness,E.printOverlay,E.multiThickness]
    .forEach(el => el.addEventListener('change', compute));
  E.printQty.addEventListener('input', compute);
  $('btnClear').addEventListener('click', () => {
    document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
    E.printQty.value = '0';
    compute();
  });
}
</script>
</body>
</html>